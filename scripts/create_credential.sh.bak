#!/bin/bash

function auto_remove() {
        # [ $# -lt 1 ] && exit
        for arg in $@:
        do
                [ -f $arg ] && rm -rf $arg 1>/dev/null
        done
}

function make_private_key() {
	openssl genrsa -out $1 4096
}

function make_csr() {
	openssl req \
-new \
-sha256 \
-config $1 \
-key $2 \
-out $3
}

function make_crt() {
	openssl x509 \
-req \
-days 36500 \
-in $1 \
-signkey $2 \
-out $3
}

function make_pem() {
	openssl req -new -x509 -key $1 -out $2 -days 36500
}

function main() {
	echo -n 'Remove old credentials...'
	auto_remove ca.key ca.csr ca.crt ca.pem
	auto_remove server.key server.csr server.pem
	auto_remove client.key client.csr client.pem
	echo ' OK'

	echo -n 'Create CA credentials...'
	make_private_key ca.key
	make_csr ca.conf ca.key ca.csr
	make_crt ca.csr ca.key ca.crt
	make_pem ca.key ca.pem
	echo ' OK'

	echo -n 'Create Server credentials...'
	make_private_key server.key
	make_csr server.conf server.key server.csr
	make_crt server.csr server.key server.crt
	make_pem server.key server.pem

}

